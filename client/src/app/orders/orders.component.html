
<div class="d-flex justify-content-between align-items-center mt-4 page-header">
  <h2 class="mb-0 page-title">Manage Orders</h2>
</div>

<div class="container mt-4 mx-5">
  <div class="card soft-card fade-in">
    <div class="card-header fw-bold">Orders Information</div>

    <div class="card-body">
      <!-- Alerts -->
      <div *ngIf="showError" class="alert alert-danger" role="alert">
        {{ errorMessage }}
      </div>
      <div *ngIf="showMessage" class="alert alert-success" role="alert">
        {{ responseMessage }}
      </div>

      <!-- Cards grid -->
      <div class="order-grid" *ngIf="orderList.length > 0">
        <article
          class="order-card fade-in-up"
          *ngFor="let val of orderList; let i = index; trackBy: trackByOrderId"
          [hidden]="isOrderRejected(val.id)"
          [ngClass]="[
            cardToneClass(i),
            isDelivered(val.status) ? 'is-delivered' : '',
            isShaking(val.id) ? 'is-shaking' : ''
          ]"
          (click)="shakeCard(val.id)"
          (touchstart)="shakeCard(val.id)"
          (animationend)="onAnimationEnd(val.id, $event)"
          tabindex="0"
          aria-label="Order card"
        >
          <div class="card-accent"></div>

          <!-- Corner ribbon for Delivered (contained) -->
          <div class="corner-ribbon" *ngIf="isDelivered(val.status)" aria-hidden="true">
            <span class="ribbon-chip">
              <span class="ribbon-icon">‚úî</span>
              Delivered
            </span>
          </div>

          <!-- Header -->
          <div class="order-card-header d-flex align-items-center justify-content-between">
            <div class="order-id">#{{ val.id }}</div>
            <span class="status-chip" *ngIf="val.status !== 'Delivered'" [ngClass]="statusClass(val.status)">{{ val.status }}</span>
          </div>

          <!-- Meta -->
          <div class="order-meta">
            <div class="meta-item">
              <span class="meta-label">Order Date</span>
              <span class="meta-value">{{ val.orderDate | date: 'dd-MMM-yyyy' }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Quantity</span>
              <span class="meta-value">{{ val.quantity }}</span>
            </div>
          </div>

          <!-- Equipment -->
          <div class="info-block">
            <div class="info-title">
              <span class="dot dot-eq"></span> Equipment
            </div>
            <div class="info-content">
              <div class="info-row"><span class="key">Id:</span> <span class="val">{{ val.equipment?.id }}</span></div>
              <div class="info-row"><span class="key">Name:</span> <span class="val">{{ val.equipment?.name }}</span></div>
              <div class="info-row">
                <span class="key">Description:</span>
                <span class="val">{{ val.equipment?.description }}</span>
              </div>
            </div>
          </div>

          <!-- Hospital + Map -->
          <div class="info-block">
            <div class="info-title">
              <span class="dot dot-hosp"></span> Hospital
            </div>
            <div class="info-content">
              <div class="info-row"><span class="key">Id:</span> <span class="val">{{ val.equipment?.hospital?.id }}</span></div>
              <div class="info-row"><span class="key">Name:</span> <span class="val">{{ val.equipment?.hospital?.name }}</span></div>
              <div class="info-row"><span class="key">Location:</span> <span class="val">{{ val.equipment?.hospital?.location }}</span></div>

              <!-- Map Actions -->
              <div class="mt-2 d-flex gap-2">
                <button
                  class="btn btn-map btn-sm"
                  type="button"
                  (click)="toggleMap(val.id); $event.stopPropagation()"
                  [disabled]="!hasHospitalInfo(val)"
                  title="View Map"
                >
                  <span class="btn-icon">üó∫Ô∏è</span>
                  {{ isMapOpen(val.id) ? 'Hide Map' : 'View Map' }}
                </button>
              </div>

              <!-- Embedded Map -->
              <div class="map-container fade-in" *ngIf="isMapOpen(val.id)">
                <iframe
                  [src]="getMapUrl(val)"
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"
                  allowfullscreen
                  title="Hospital Location Map"
                ></iframe>
              </div>
            </div>
          </div>

          <!-- Accepted By -->
          <!-- <div class="info-block" *ngIf="val.assignedSupplierName">
            <div class="info-title">
              <span class="dot dot-acc"></span> Accepted By
            </div>
            <div class="info-content">
              <div class="info-row">
                <span class="key">Supplier:</span>
                <span class="val">{{ val.assignedSupplierName }}</span>
              </div>
            </div>
          </div> -->
          <!-- Requested By -->
<div class="info-block">
  <div class="info-title">
    <span class="dot dot-acc"></span> Requested By
  </div>
  <div class="info-content">
    <div class="info-row">
      <span class="key">Admin:</span>
      <span class="val">{{ val.requestedBy || '-' }}</span>
    </div>
  </div>
</div>


          <!-- Actions -->
          <div class="order-actions">
            <!-- 1) PENDING => Accept + Reject -->
            <ng-container *ngIf="(val.requestStatus || 'PENDING') === 'PENDING' && !isDelivered(val.status)">
              <button class="btn btn-accept btn-sm" type="button" (click)="acceptOrder(val.id); $event.stopPropagation()">
                <span class="btn-icon">‚úÖ</span> Accept
              </button>

              <button class="btn btn-reject btn-sm" type="button" (click)="rejectOrderLocally(val.id); $event.stopPropagation()">
                <span class="btn-icon">‚úñ</span> Reject
              </button>
            </ng-container>

            <!-- 2) ACCEPTED by me => Update Status -->
            <ng-container *ngIf="canEditOrder(val)">
              <button
                class="btn btn-gradient btn-sm"
                type="button"
                data-bs-toggle="modal"
                data-bs-target="#driverModal"
                (click)="edit(val); $event.stopPropagation()"
                [disabled]="isDelivered(val.status)"
              >
                <span class="btn-icon">‚úèÔ∏è</span> Update Status
              </button>
            </ng-container>

            <!-- 3) Accepted by others -->
            <div
              *ngIf="(val.requestStatus || '').toUpperCase() === 'ACCEPTED' && !canEditOrder(val) && !isDelivered(val.status)"
              class="text-muted"
            >
              Assigned to {{ val.assignedSupplierName || 'Supplier' }}
            </div>

            <!-- 4) Delivered -->
            <div *ngIf="isDelivered(val.status)" class="completed-pill">Completed</div>
          </div>
        </article>
      </div>

      <!-- Empty -->
      <div *ngIf="orderList.length === 0 && !showError" class="alert alert-info" role="alert">
        No orders found.
      </div>
    </div>
  </div>
</div>

<!-- Modal (Update Status) -->
<div
  class="modal fade"
  id="driverModal"
  tabindex="-1"
  aria-labelledby="driverModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content modal-soft">
      <div class="modal-header">
        <h5 class="modal-title" id="driverModalLabel">Update Status</h5>
        <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <select
          [(ngModel)]="statusModel.newStatus"
          class="form-control"
          id="status"
          aria-label="Choose Status"
        >
          <option value="null">Choose Status</option>
          <option value="In Transit">In Transit</option>
          <option value="Delivered">Delivered</option>
        </select>

        <div *ngIf="showMessage" class="alert alert-success mt-4" role="alert">
          {{ responseMessage }}
        </div>
        <div *ngIf="showError" class="alert alert-danger" role="alert">
          {{ errorMessage }}
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-gradient" (click)="update()">Save</button>
      </div>
    </div>
  </div>
</div>


<div class="d-flex justify-content-between align-items-center mt-4 page-header">
  <h2 class="mb-0 page-title">Manage Maintenance</h2>
</div>

<div class="container mt-4 mx-5">
  <div class="card soft-card fade-in">
    <div class="card-header fw-bold">Maintenance Information</div>

    <div class="card-body">
      <div *ngIf="showError" class="alert alert-danger" role="alert">
        {{ errorMessage }}
      </div>

      <!-- Card grid -->
      <div class="maint-grid">
        <article
          class="maint-card fade-in-up"
          *ngFor="let m of maintenanceList; let i = index; trackBy: trackByMaintId"
          [hidden]="isRejected(m.id)"
          [ngClass]="[
            cardToneClass(i),
            isServiced(m.status) ? 'is-serviced' : '',
            isShaking(m.id) ? 'is-shaking' : ''
          ]"
          (click)="shakeCard(m.id)"
          (touchstart)="shakeCard(m.id)"
          (animationend)="onAnimationEnd(m.id, $event)"
          tabindex="0"
          aria-label="Maintenance card"
        >
          <div class="card-accent"></div>

          <!-- Compact, pretty corner ribbon (contained inside the card) -->
          <div class="corner-ribbon" *ngIf="isServiced(m.status)" aria-hidden="true">
            <span class="ribbon-chip">
              <span class="ribbon-icon">‚úî</span>
              Serviced
            </span>
          </div>

          <!-- Summary header -->
          <div class="maint-card-header d-flex align-items-center justify-content-between">
            <div class="maint-id">#{{ m.id }}</div>
            <span class="status-chip" [ngClass]="statusClass(m.status)">{{ m.status }}</span>
          </div>

          <!-- Meta -->
          <div class="maint-meta">
            <div class="meta-item">
              <span class="meta-label">Scheduled</span>
              <span class="meta-value">{{ m.scheduledDate | date: 'dd/MM/yyyy' }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Completion</span>
              <span class="meta-value">{{ m.completedDate | date: 'dd/MM/yyyy' }}</span>
            </div>
          </div>

          <!-- Assigned To -->
          <div class="info-block">
            <div class="info-title">
              <span class="dot dot-tech"></span> Assigned To
            </div>
            <div class="info-content">
              <div class="info-row">
                <span class="key">Technician:</span>
                <span class="val">{{ m.assignedTechnicianName || '-' }}</span>
              </div>
            </div>
          </div>

          <!-- Equipment -->
          <div class="info-block">
            <div class="info-title">
              <span class="dot dot-eq"></span> Equipment
            </div>
            <div class="info-content">
              <div class="info-row"><span class="key">Id:</span> <span class="val">{{ m.equipment?.id }}</span></div>
              <div class="info-row"><span class="key">Name:</span> <span class="val">{{ m.equipment?.name }}</span></div>
              <div class="info-row">
                <span class="key">Description:</span>
                <span class="val">{{ m.equipment?.description }}</span>
              </div>
            </div>
          </div>

          <!-- Hospital + Map -->
          <div class="info-block">
            <div class="info-title">
              <span class="dot dot-hosp"></span> Hospital
            </div>
            <div class="info-content">
              <div class="info-row">
                <span class="key">Id:</span>
                <span class="val">{{ m.equipment?.hospital?.id }}</span>
              </div>
              <div class="info-row">
                <span class="key">Name:</span>
                <span class="val">{{ m.equipment?.hospital?.name }}</span>
              </div>
              <div class="info-row">
                <span class="key">Location:</span>
                <span class="val">{{ m.equipment?.hospital?.location }}</span>
              </div>

              <!-- Map Actions -->
              <div class="mt-2 d-flex gap-2">
                <button
                  class="btn btn-map btn-sm"
                  type="button"
                  (click)="toggleMap(m.id); $event.stopPropagation()"
                  [disabled]="!hasHospitalInfo(m)"
                  title="View Map"
                >
                  <span class="btn-icon">üó∫Ô∏è</span>
                  {{ isMapOpen(m.id) ? 'Hide Map' : 'View Map' }}
                </button>
              </div>

              <!-- Embedded Map (DomSanitizer SafeResourceUrl) -->
              <div class="map-container fade-in" *ngIf="isMapOpen(m.id)">
                <iframe
                  [src]="getMapUrl(m)"
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"
                  allowfullscreen
                  title="Hospital Location Map"
                ></iframe>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="maint-actions">
            <!-- 1) Pending request: Accept & Reject -->
            <ng-container *ngIf="(m.requestStatus || 'PENDING') === 'PENDING' && m.status !== 'Serviced'">
              <button class="btn btn-accept btn-sm" type="button" (click)="accept(m.id); $event.stopPropagation()">
                <span class="btn-icon">‚úÖ</span> Accept
              </button>

              <button class="btn btn-reject btn-sm" type="button" (click)="rejectLocally(m.id); $event.stopPropagation()">
                <span class="btn-icon">‚úñ</span> Reject
              </button>
            </ng-container>

            <!-- 2) Accepted by me: Edit -->
            <ng-container *ngIf="canEdit(m)">
              <button
                class="btn btn-ghost btn-sm"
                type="button"
                data-bs-toggle="modal"
                data-bs-target="#driverModal"
                (click)="edit(m); $event.stopPropagation()"
              >
                <span class="btn-icon">‚úèÔ∏è</span> Edit
              </button>
            </ng-container>

            <!-- 3) Serviced -->
            <ng-container *ngIf="m.status === 'Serviced'">
              <div class="completed-pill">Completed</div>
            </ng-container>
          </div>
        </article>

        <!-- Empty state -->
        <div class="empty-state" *ngIf="!maintenanceList || maintenanceList.length === 0">
          <div class="empty-illustration">üóÇÔ∏è</div>
          <p class="empty-text">No maintenance records to show.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal (Update Maintenance) -->
<div
  class="modal fade"
  id="driverModal"
  tabindex="-1"
  aria-labelledby="driverModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content modal-soft">
      <div class="modal-header">
        <h5 class="modal-title" id="driverModalLabel">Update Maintenance</h5>
        <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form class="mb-3 mt-md-2" [formGroup]="itemForm" (ngSubmit)="update()" novalidate>
          <div class="mb-3">
            <label for="scheduledDate" class="form-label fw-semibold">Scheduled Date</label>
            <input type="hidden" id="maintenanceId" formControlName="maintenanceId" />
            <input type="date" id="scheduledDate" class="form-control" formControlName="scheduledDate" [readOnly]="true" />
          </div>

          <div class="mb-3">
            <label for="completedDate" class="form-label fw-semibold">Completion Date</label>
            <input type="date" id="completedDate" class="form-control" formControlName="completedDate" />
            <div
              *ngIf="
                itemForm.controls['completedDate'].invalid &&
                (itemForm.controls['completedDate'].dirty || itemForm.controls['completedDate'].touched)
              "
              class="text-danger mt-1"
            >
              Please enter Completed Date.
            </div>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label fw-semibold">Feedback</label>
            <input
              type="text"
              id="description"
              class="form-control"
              formControlName="description"
              placeholder="Description"
            />
            <div
              *ngIf="
                itemForm.controls['description'].invalid &&
                (itemForm.controls['description'].dirty || itemForm.controls['description'].touched)
              "
              class="text-danger mt-1"
            >
              Please enter Description.
            </div>
          </div>

          <div class="mb-3">
            <label for="status" class="form-label fw-semibold">Status</label>
            <select id="status" class="form-control" formControlName="status">
              <option value="">Choose Option</option>
              <option value="In Progress">In Progress</option>
              <option value="Serviced">Serviced</option>
            </select>
            <div
              *ngIf="
                itemForm.controls['status'].invalid &&
                (itemForm.controls['status'].dirty || itemForm.controls['status'].touched)
              "
              class="text-danger mt-1"
            >
              Please choose status.
            </div>
          </div>

          <div class="d-flex justify-content-end">
            <button class="btn btn-gradient" type="submit" [disabled]="itemForm.invalid">
              <span class="btn-icon">üíæ</span> Submit
            </button>
          </div>
        </form>

        <div *ngIf="showMessage" class="alert alert-success mt-3" role="alert" aria-live="polite">
          {{ responseMessage }}
        </div>
      </div>
    </div>
  </div>
</div>
